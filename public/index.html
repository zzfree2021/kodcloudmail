<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ä¸´æ—¶é‚®ç®±</title>
    <!-- è¿è¡Œæ—¶æ³¨å…¥åŸŸååˆ—è¡¨ï¼ˆä» env.MAIL_DOMAIN è§£æï¼‰ï¼Œç”¨äºå‰ç«¯åŸŸåé€‰æ‹© -->
    <meta name="mail-domains" content="">
    <link rel="preload" href="/html/app.html" as="fetch" crossorigin>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="shortcut icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/css/app.css" />
    <link rel="stylesheet" href="/css/app-mobile.css" media="(max-width: 900px)" />
    <script src="/js/toast-utils.js"></script>
    <script src="/js/mock.js"></script>
    <!-- æå‰å†…è”ä¿å­˜ hashï¼Œä¿è¯æœ€æ—©é˜¶æ®µå³å¯ä¿ç•™è·¯ç”±ä¿¡æ¯ -->
    <script>
      try{ if (location.hash){ sessionStorage.setItem('mf:preservedHash', location.hash); } }catch(_){ }
    </script>
    <script src="/js/auth-guard.js"></script>
    <script src="/js/app-router.js" defer></script>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // æ”¹è¿›çš„è·¯ç”±å®ˆå«é€»è¾‘ï¼šä¼˜å…ˆä½¿ç”¨ loading é¡µé¢è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œé¿å…ç™»å½•é¡µé—ªå±
      (function() {
        try{
          // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å…¶ä»–é¡µé¢å¯¼èˆªè¿‡æ¥ï¼ˆéåœ°å€æ ç›´æ¥è®¿é—®ï¼‰
          var isDirectAccess = !document.referrer || window.history.length <= 1;
          
          // æ£€æŸ¥è¿‘æœŸè®¤è¯æ ‡è®°ï¼ˆ10ç§’å†…ï¼‰- å»¶é•¿æ—¶é—´çª—å£ä»¥å‡å°‘é‡å¤æ£€æŸ¥
          var ts = 0; 
          try{ ts = Number(sessionStorage.getItem('auth_checked_ts') || '0'); }catch(_){ }
          var recentlyChecked = ts && (Date.now() - ts) < 10000;
          
          // å¦‚æœæœ€è¿‘å·²éªŒè¯è¿‡ï¼Œç›´æ¥åŠ è½½åº”ç”¨
          if (recentlyChecked && !isDirectAccess){
            var s1 = document.createElement('script'); 
            s1.type='module'; 
            s1.src='/js/app.js'; 
            document.body.appendChild(s1);
            try{ 
              if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ 
                var sm1=document.createElement('script'); 
                sm1.type='module'; 
                sm1.src='/js/app-mobile.js'; 
                document.body.appendChild(sm1); 
              } 
            }catch(_){ }
            return;
          }
          
              // åœ°å€æ ç›´æ¥è®¿é—®æˆ–é•¿æ—¶é—´æœªéªŒè¯ï¼šå…ˆå°è¯•å¿«é€Ÿåˆ¤æ–­æ˜¯å¦å·²æœ‰ç™»å½• Cookie
          if (isDirectAccess){
            try{
              var hasCookie = document.cookie.split(';').some(function(c){ return c.trim().indexOf('iding-session=') === 0; });
              if (hasCookie){
                // å·²æœ‰ç™»å½• Cookieï¼šä¼˜åŒ–éªŒè¯é€»è¾‘ï¼Œå‡å°‘ä¸å¿…è¦çš„ç™»å½•é¡µè·³è½¬
                const controller = new AbortController();
                const tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 3000); // å»¶é•¿è¶…æ—¶æ—¶é—´åˆ°3ç§’
                fetch('/api/session', { headers:{'Cache-Control':'no-cache'}, signal: controller.signal, credentials: 'include' })
                  .then(function(r){
                    clearTimeout(tid);
                    if (!r || !r.ok) {
                      // å¯¹äºæœ‰cookieä½†éªŒè¯å¤±è´¥çš„æƒ…å†µï¼Œç›´æ¥åŠ è½½åº”ç”¨è®©å…¶å†…éƒ¨å¤„ç†
                      // é¿å…è·³è½¬åˆ°ç™»å½•é¡µé€ æˆé¡µé¢é—ªçƒ
                      try{ sessionStorage.setItem('auth_checked','true'); sessionStorage.setItem('auth_checked_ts', String(Date.now())); }catch(_){ }
                      var s1=document.createElement('script'); s1.type='module'; s1.src='/js/app.js'; document.body.appendChild(s1);
                      try{ if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ var sm=document.createElement('script'); sm.type='module'; sm.src='/js/app-mobile.js'; document.body.appendChild(sm); } }catch(_){ }
                      return;
                    }
                    return r.json();
                  })
                  .then(function(s){
                    if (!s) return; 
                    if (s.role === 'mailbox') { window.location.replace('/html/mailbox.html'); return; }
                    try{ sessionStorage.setItem('auth_checked','true'); sessionStorage.setItem('auth_checked_ts', String(Date.now())); }catch(_){ }
                    // åŠ è½½åº”ç”¨
                    var s1=document.createElement('script'); s1.type='module'; s1.src='/js/app.js'; document.body.appendChild(s1);
                    try{ if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ var sm=document.createElement('script'); sm.type='module'; sm.src='/js/app-mobile.js'; document.body.appendChild(sm); } }catch(_){ }
                  })
                  .catch(function(){
                    // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå¦‚æœæœ‰cookieå°±ç›´æ¥åŠ è½½åº”ç”¨ï¼Œè®©åº”ç”¨å†…éƒ¨å¤„ç†è®¤è¯çŠ¶æ€
                    // è¿™æ ·é¿å…äº†ç½‘ç»œé—®é¢˜å¯¼è‡´çš„ä¸å¿…è¦ç™»å½•é¡µè·³è½¬
                    try{ sessionStorage.setItem('auth_checked','true'); sessionStorage.setItem('auth_checked_ts', String(Date.now())); }catch(_){ }
                    var s1=document.createElement('script'); s1.type='module'; s1.src='/js/app.js'; document.body.appendChild(s1);
                    try{ if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ var sm=document.createElement('script'); sm.type='module'; sm.src='/js/app-mobile.js'; document.body.appendChild(sm); } }catch(_){ }
                  });
                return;
              }
            }catch(_){ }
            // æ˜¾ç¤º loading ç•Œé¢ï¼ŒåŒæ—¶è¿›è¡Œæƒé™æ£€æŸ¥
            var loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '<div style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#f8fafc;z-index:9999"><div style="text-align:center"><div style="font-size:3rem;margin-bottom:1rem">ğŸ“§</div><div style="width:40px;height:40px;border:3px solid rgba(59,130,246,0.2);border-top:3px solid #3b82f6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style></div></div>';
            document.body.appendChild(loadingDiv);
            
            // å¹¶è¡Œè¿›è¡Œæƒé™æ£€æŸ¥
            const controller = new AbortController();
            const tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 2500); // å»¶é•¿è¶…æ—¶åˆ°2.5ç§’
            fetch('/api/session', { 
              headers: { 'Cache-Control': 'no-cache' }, 
              signal: controller.signal,
              credentials: 'include'
            })
              .then(function(r){
                clearTimeout(tid);
                if (r && r.ok){
                  return r.json().then(function(s){
                    if (s && s.role === 'mailbox') { window.location.replace('/html/mailbox.html'); return null; }
                    return s;
                  });
                } else {
                  // è·³è½¬åˆ° loading é¡µé¢è¿›è¡Œæ›´å®Œæ•´çš„æƒé™æ£€æŸ¥
                  window.location.replace('/templates/loading.html?redirect=/');
                  return null;
                }
              })
              .then(function(s){
                if (!s) return; 
                  try{ 
                    sessionStorage.setItem('auth_checked','true'); 
                    sessionStorage.setItem('auth_checked_ts', String(Date.now())); 
                  }catch(_){ }
                  // ç§»é™¤ loading ç•Œé¢
                  if (loadingDiv) loadingDiv.remove();
                  // åŠ è½½åº”ç”¨
                  var s = document.createElement('script');
                  s.type = 'module';
                  s.src = '/js/app.js';
                  document.body.appendChild(s);
                  try{ 
                    if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ 
                      var sm=document.createElement('script'); 
                      sm.type='module'; 
                      sm.src='/js/app-mobile.js'; 
                      document.body.appendChild(sm);
                    } 
                  }catch(_){ }
              })
              .catch(function(){ 
                // ç½‘ç»œé”™è¯¯æ—¶è·³è½¬åˆ° loading é¡µé¢
                window.location.replace('/templates/loading.html?redirect=/');
              });
          } else {
            // éç›´æ¥è®¿é—®ï¼šå¿«é€Ÿæƒé™æ£€æŸ¥
            var hasCookie = false;
            try{ hasCookie = document.cookie.split(';').some(function(c){ return c.trim().indexOf('iding-session=') === 0; }); }catch(_){ }
            
            const controller = new AbortController();
            const tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 2000); // å»¶é•¿è¶…æ—¶åˆ°2ç§’
            fetch('/api/session', { 
              headers: { 'Cache-Control': 'no-cache' }, 
              signal: controller.signal,
              credentials: 'include'
            })
              .then(function(r){
                clearTimeout(tid);
                if (r && r.ok){
                  return r.json().then(function(s){
                    if (s && s.role === 'mailbox') { window.location.replace('/html/mailbox.html'); return null; }
                    return s;
                  });
                } else {
                  // å¦‚æœæœ‰cookieä½†éªŒè¯å¤±è´¥ï¼Œè®©åº”ç”¨å†…éƒ¨å¤„ç†è€Œä¸æ˜¯ç«‹å³è·³è½¬åˆ°ç™»å½•é¡µ
                  if (hasCookie) {
                    try{ sessionStorage.setItem('auth_checked','true'); sessionStorage.setItem('auth_checked_ts', String(Date.now())); }catch(_){ }
                    var s1 = document.createElement('script'); s1.type = 'module'; s1.src = '/js/app.js'; document.body.appendChild(s1);
                    try{ if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ var sm=document.createElement('script'); sm.type='module'; sm.src='/js/app-mobile.js'; document.body.appendChild(sm); } }catch(_){ }
                    return null;
                  }
                  window.location.replace('/html/login.html');
                  return null;
                }
              })
              .then(function(s){
                if (!s) return; 
                try{ 
                  sessionStorage.setItem('auth_checked','true'); 
                  sessionStorage.setItem('auth_checked_ts', String(Date.now())); 
                }catch(_){ }
                var s1 = document.createElement('script');
                s1.type = 'module';
                s1.src = '/js/app.js';
                document.body.appendChild(s1);
                try{ 
                  if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ 
                    var sm=document.createElement('script'); 
                    sm.type='module'; 
                    sm.src='/js/app-mobile.js'; 
                    document.body.appendChild(sm);
                  } 
                }catch(_){ }
              })
              .catch(function(){ 
                // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå¦‚æœæœ‰cookieå°±ç›´æ¥åŠ è½½åº”ç”¨
                if (hasCookie) {
                  try{ sessionStorage.setItem('auth_checked','true'); sessionStorage.setItem('auth_checked_ts', String(Date.now())); }catch(_){ }
                  var s1 = document.createElement('script'); s1.type = 'module'; s1.src = '/js/app.js'; document.body.appendChild(s1);
                  try{ if (window.matchMedia && window.matchMedia('(max-width: 900px)').matches){ var sm=document.createElement('script'); sm.type='module'; sm.src='/js/app-mobile.js'; document.body.appendChild(sm); } }catch(_){ }
                } else {
                  window.location.replace('/html/login.html'); 
                }
              });
          }
        }catch(_){ 
          window.location.replace('/templates/loading.html?redirect=/'); 
        }
      })();
    </script>
  </body>
  </html>

